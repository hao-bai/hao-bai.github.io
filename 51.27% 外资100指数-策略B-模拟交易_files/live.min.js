function setCookie(e,t,o){if(!o)o=30;var i=new Date;i.setTime(i.getTime()+60*o*1e3),document.cookie=e+"="+escape(t)+";expires="+i.toGMTString()+";path=/"}function getCookie(e){var t,o=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(o))?unescape(t[2]):null}function delCookie(e){var t=new Date;t.setTime(t.getTime()-1);var o=getCookie(e);null!=o&&(document.cookie=e+"="+o+";expires="+t.toGMTString()+";path=/")}
$(function(){var $node=$("body"),backtestId=$("#backtestId").val(),algorithmId=$("#algorithmId").val(),pyVersion=$("#tradePyVersion").val(),initDone=!1,startDate=$("#transaction-date").attr("_startDate"),lastDate=$("#transaction-date").attr("_lastDate"),lastDay=lastDate,accessControl=$("#accessControl").val(),d=new Date,monthStr=d.getMonth()+1,strDate=d.getDate(),today,chart,daychart,bootchart,resultOffset=0,userRecordOffset=0,logOffset=0,stopCycle=!1,stopResult=!1,stopdayResult=!1,dataResult=[],dataBenchmark=[],origDataOffset=0,userRecord=null,startDate=$("#startDate").val(),frequency=$("#frequency").val(),statLoading=!1,logBottomOffset=0,logTopOffset=-1,errorLogOffset=0,stopLog=!0,stopErrorLog=!0,logLimit=100,chartClick=0,pointClick=0,daydataResult=[],daydatabenchmark=[],chartHoverPointIndex=0,positionLoading=!1,positionMod="today",positionGrid=null,positionTdWidth=null,positionDisplayCols=["amount","price","position","gain","gainPercent"],transactionBottomOffset=0,transactionTopOffset=-1,transactionGrid=null,transactionLoading=!1,transactionMod="today",transactionTdWidth=null,transactionDisplayCols=["amount","transaction","type","price","total","gains","commission"],chartStat,statOffset=0,statRecord=[],stopStat=!0,chartStatHoverPointIndex=0,newclipboard=new ClipboardJS(".applyShareUrl-copy"),editor=null,status=$("#status").val(),switchFlag=!1,cancelSwitchFlag=!1,clipboardHidden=!1,drawExcessResult={},excessResult=[],dayExcessResult=[],bootExcessResult=[],flag=!1,isInitFlag=!1,fillDataFlag=!0,initDataResult=[],initDataBenchmark=[],currentPage=0,selectedBacktestName,sourceBacktestId,totalCount,chartInitDrawFLag,isOwner=!!$("#isOwner").val(),pyVersion=$("#tradePyVersion").val(),moreTFoot='<tfoot><tr class="ui-widget-content jqgrow ui-row-ltr"><td class="gridcell" colspan="100" style="text-align: center"><strong>更多数据请使用研究get_backtest函数或者导出</strong></td></tr></tfoot>',isDelayTrade=!1,algorithmCode="",handleToggleDrapdown=function(){$node.find("#clickDrapdown").hover(function(){var t=$(this);g_isMobile||(t.addClass("checked"),t.find(".open_span").addClass("open"),$node.find(".clickDrapdown").removeClass("hidden"))},function(){var t=$(this);g_isMobile||"true"==t.attr("clicked")||(t.removeClass("checked"),t.find(".open_span").removeClass("open"),$node.find(".clickDrapdown").addClass("hidden"))}),$("#clickDrapdown").click(function(){var t=$(this);if(!g_isMobile)if("true"==t.attr("clicked"))t.attr("clicked","false");else if("false"==t.attr("clicked"))return t.attr("clicked","true"),!1;t.toggleClass("checked"),t.find(".open_span").toggleClass("open"),$node.find(".clickDrapdown").toggleClass("hidden")})},deepCopy=function(t){if(t instanceof Array){for(var e=[],a=0;a<t.length;++a)e[a]=deepCopy(t[a]);return e}if(t instanceof Object){e={};for(var a in t)e[a]=deepCopy(t[a]);return e}return t},setRangeAllIndex=function(t,e){chartInitDrawFLag=!1,t.rangeSelector.clickButton(e,{type:"all"},!0)},cancel=function(){Cy.ajax("/algorithm/index/cancel",{data:"backtestId="+backtestId,async:!1,success:function(t){return $("#stopBtn").addClass("hidden"),$("#tradeTime").html("<span class='tips'>已停止</span>"),$("#restartBtn").removeClass("hidden"),!1},fail:function(t){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"无法停止:"+t.msg})}})},restart=function(e){Cy.ajax("/algorithm/live/restart",{data:"backtestId="+backtestId,async:!1,success:function(t){setTimeout("window.location.href = window.location.href;",1e3)},fail:function(t){e&&e(-1),BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"无法启动:"+t.msg})}})},pause=function(e){Cy.ajax("/algorithm/live/pause",{data:"backtestId="+backtestId,async:!1,success:function(t){setTimeout("window.location.href = window.location.href;",1e3)},fail:function(t){e&&e(-1),BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"无法暂停:"+t.msg})}})},finish=function(e){Cy.ajax("/algorithm/live/finish",{data:"backtestId="+backtestId,async:!1,success:function(t){setTimeout("window.location.href = window.location.href;",1e3)},fail:function(t){e&&e(-1),BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"无法关闭:"+t.msg})}})},resume=function(e){Cy.ajax("/algorithm/live/resume",{data:"backtestId="+backtestId,async:!1,success:function(t){setTimeout("window.location.href = window.location.href;",1e3)},fail:function(t){e&&e(-1),BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"无法重启:"+t.msg})}})},drawChartData=function(){stopResult||drawResult(backtestId),isDelayTrade||dayResult(),drawStat(backtestId),$("body").hasClass("mobile")||("today"==positionMod&&getPosition(lastDate,1),"today"==transactionMod&&getTransaction(lastDate)),fillStats(),fillLog()},tradeTimeCheck=function(t){var e,a,o,i=$("#currentTime").val();if(i){var n=i.split(" ")[1].split(":");e=parseInt(n[0]),a=parseInt(n[1]),parseInt(n[2]),o=60*e+a}else o=60*(e=(i=new Date).getHours())+(a=i.getMinutes());var s=$("#accountType").val(),r=!1;s&&(s=JSON.parse(s)).length&&s.map(function(t,e){"futures"!==t&&"index_futures"!==t||(r=!0)});var l,d=!1,c="";r?o<540?(c=o<150?"期货夜盘时段":isDelayTrade?"延时进行中(未开盘)":"进行中(未开盘)",d=o<150||d):691<o&&o<780?c=isDelayTrade?"延时进行中(休市)":"进行中(休市)":d=930<o?(c=1260<=o?"期货夜盘时段":isDelayTrade?"延时进行中(已收盘)":"进行中(已收盘)",1260<=o||d):(c=isDelayTrade?"延时进行中":"进行中",!0):o<570?(c=o<150?"期货夜盘时段":isDelayTrade?"延时进行中(未开盘)":"进行中(未开盘)",d=o<150||d):691<o&&o<780?c=isDelayTrade?"延时进行中(休市)":"进行中(休市)":d=905<o?(c=1260<=o?"期货夜盘时段":isDelayTrade?"延时进行中(已收盘)":"进行中(已收盘)",1260<=o||d):(c=isDelayTrade?"延时进行中":"进行中",!0),l='<span class="tips">'+c+"</span>",$("#tradeTime").html(l),!t&&d&&drawChartData(),setTimeout(tradeTimeCheck,12e4)},fillStats=function(){statLoading=!0,Cy.ajax("/algorithm/live/stat?offset=-1&limit=1&backtestId="+backtestId,{error:function(t){},fail:function(){statLoading=!1},success:function(t){if(!t.data.stat||!t.data.stat.sharpe||t.data.stat.sharpe.value.length<=0)statLoading=!1;else{if($("#sharpe").html(t.data.stat.sharpe.value[0].toFixed(3)),$("#maxDrawdown").html((100*t.data.stat.max_drawdown.value[0]).toFixed(2)+"%"),t.data.stat.annual_algo_return.value[0])var e=t.data.stat.annual_algo_return.value[0];else{var a=t.data.stat.trading_days.value[0]/250;e=Math.pow(1+t.data.stat.algorithm_return.value[0],1/a)-1}$("#year_returns").html((100*e).toFixed(2)+"%"),e<0?($("#year_returns").parent().removeClass("money_red"),$("#year_returns").parent().addClass("money_green")):($("#year_returns").parent().removeClass("money_green"),$("#year_returns").parent().addClass("money_red")),statLoading=!1,$("#avg_excess_return").text(t.data.stat.avg_excess_return.value[0]||"--"),$("#excess_return_max_drawdown").text(t.data.stat.excess_return_max_drawdown.value[0]||"--"),$("#excess_return_sharpe").text(t.data.stat.excess_return_sharpe.value[0]||"--");var o=chart.get("overallReturnMaxDrawdown");o&&o.remove();var i=t.data.stat.max_drawdown_period&&t.data.stat.max_drawdown_period.value[0]||null;if(i){if(i[0]===i[1])return;i=i.map(function(t,e){return 0<=t.indexOf("-")&&(t=t.split("-").join("/")),t}),chart.addSeries({type:"flags",id:"overallReturnMaxDrawdown",data:[{x:Date.parse(new Date(i[0]+" 16:00:00")),title:" ",text:"最大回撤"},{x:Date.parse(new Date(i[1]+" 16:00:00")),title:" ",text:"最大回撤"}],onSeries:"overallReturn",fillColor:"#00BB00",states:{hover:{fillColor:"#00BB00"}},shape:"circlepin",y:-3,height:4,width:4})}}}})},fillLog=function(){stopLog||(stopLog=!0,Cy.ajax("/algorithm/live/log?backtestId="+backtestId+"&offset="+logTopOffset,{error:function(){stopLog=!1},fail:function(){stopLog=!1},success:function(t){if(0!=t.data.logArr.length||2!=t.data.state&&3!=t.data.state){for(var e="",a=t.data.logArr.length-1;0<=a;a--){var o=t.data.logArr[a].split(" - ");if(2<o.length){var i='<span class="log-date">'+o[0]+"</span> - ";if("ERROR"==o[1])var n="log-error";else if("WARNING"==o[1])n="log-warning";else n="log-info";var s='<span class="'+n+'">'+o[1]+"</span> - ";o.shift(),o.shift();var r=i+s+o.join("-")}else r=t.data.logArr[a];e=e+"<p>"+r.replace(/\n/g,"<br/>")}""==e&&$("#log").children().length<=0&&(e="<p>暂无日志</p>"),$("#log").find("pre").eq(0).prepend(e),-1==logTopOffset&&($("#log-item").attr("_hasDrawn",1),$("#logs-loading").addClass("hidden"),$("#pane_logs").scrollTop(0),$("#pane_logs").scroll(function(){nScrollHight=$(this)[0].scrollHeight,nScrollTop=$(this)[0].scrollTop,paneHeight=$("#log").height(),nScrollTop+$(this).height()>=paneHeight&&addLog(nScrollTop)}),logBottomOffset=parseInt(t.data.offset)),logTopOffset=parseInt(t.data.offset)+parseInt(t.data.logArr.length),stopLog=!1}}}))},fillErrorLog=function(){Cy.ajax("/algorithm/backtest/error?backtestId="+backtestId+"&offset="+errorLogOffset,{fail:function(t){},success:function(t){var e=$("#log"),a=$(".logs-switch"),o=$("#error-log").show().find("pre").eq(0);if(0!=t.data.logArr.length||2!=t.data.state&&3!=t.data.state){for(var i="",n=0;n<t.data.logArr.length;n++)i=i+"<p>"+t.data.logArr[n].replace(/\n/g,"<br/>"),errorLogOffset++;i&&(e.hide(),a.find(".active").removeClass("active"),a.find('span[data-target="error-log"]').addClass("active"),o.append(i))}else stopErrorLog=!0}})},addLog=function(t){if(!(stopLog||logBottomOffset<=0)){stopLog=!0,null==typeof t&&(t=0);var e=Math.max(0,logBottomOffset-logLimit),a=Math.min(logLimit,logBottomOffset);Cy.ajax("/algorithm/live/log?addLog=1&backtestId="+backtestId+"&offset="+e+"&limit="+a,{error:function(){stopLog=!1},fail:function(){stopLog=!1},success:function(t){if(0!=t.data.logArr.length||2!=t.data.state&&3!=t.data.state){for(var e=t.data.logArr.length-1;0<=e;e--){var a=t.data.logArr[e].split(" - ");if(2<a.length){var o='<span class="log-date">'+a[0]+"</span> - ";if("ERROR"==a[1])var i="log-error";else if("WARNING"==a[1])i="log-warning";else i="log-info";var n='<span class="'+i+'">'+a[1]+"</span> - ";a.shift(),a.shift();var s=o+n+a.join("-")}else s=t.data.logArr[e];$("#log").find("pre").eq(0).append("<p>"+s+"</p>"),logBottomOffset--}stopLog=!1}}})}},initResult=function(p,g){Cy.ajax("/algorithm/backtest/result?backtestId="+p+"&offset="+resultOffset+"&userRecordOffset="+userRecordOffset,{error:function(t){},fail:function(t){},success:function(t){if(0==t.data.state)return $("#historical_earnings").html('<p style="padding:10px;">未开始，暂无数据</p>'),void g();var e=t.data.result.count;if(e<=0&&null==t.data.userRecord){if(0<dataResult.length){var a=dataResult[dataResult.length-1].y.toFixed(2);excessResult=initChartData(chart,newChart,dataResult,dataBenchmark,userRecord,!0),updateTotalReturn(a),chart.redraw(),clearHighchartLable(),$("#portfolio-perf-label").removeClass("hidden"),setRangeAllIndex(chart,4)}else $("#historical_earnings").html('<p style="padding:10px;">暂无数据</p>');return initDataResult=deepCopy(dataResult),initDataBenchmark=deepCopy(dataBenchmark),void g()}for(var o=parseInt(t.data.result.offset),i={},n=9999999999999,s=0;s<e;s++){if(dataResult[s+o]={},dataResult[s+o].x=t.data.result.overallReturn.time[s],dataResult[s+o].y=t.data.result.overallReturn.value[s],dataBenchmark[s+o]={},dataBenchmark[s+o].x=t.data.result.benchmark.time[s],dataBenchmark[s+o].y=t.data.result.benchmark.value[s],i[u=86400*parseInt(t.data.result.benchmark.time[s]/1e3/86400)*1e3-288e5]=s+o,n=t.data.result.benchmark.time[s],t.data.userRecord)for(var r in userRecord=userRecord||{},t.data.userRecord){if(!userRecord[r]){userRecord[r]=[];for(var l=0;l<=s+o;l++)userRecord[r][l]={x:null,y:null},userRecord[r][l].x=dataBenchmark[l].x,userRecord[r][l].y=null}userRecord[r][s+o]={x:null,y:null},userRecord[r][s+o].x=t.data.result.benchmark.time[s],userRecord[r][s+o].y=null}}if(t.data.userRecord){var d=0;for(var r in t.data.userRecord){var c=0;for(s=0;s<t.data.userRecord[r].time.length;s++)if(t.data.userRecord[r].time[s]){var u;if(n<(u=86400*parseInt(t.data.userRecord[r].time[s]/1e3/86400)*1e3-288e5))break;var h=i[u];userRecord[r][h]||(userRecord[r][h]={}),userRecord[r][h].y=t.data.userRecord[r].value[s],c++}d=Math.max(d,c)}userRecordOffset+=d}resultOffset=o+e,initResult(p,g)}})},renderPage=function(t,e){var a=$node.find("#pageButton"),o={bootstrapMajorVersion:3,currentPage:t,numberOfPages:10,totalPages:e,itemTexts:function(t,e,a){switch(t){case"first":return"首页";case"prev":return"上一页";case"next":return"下一页";case"last":return"末页";case"page":return e}},onPageClicked:function(t,e,a,o){getUpdateCodeHistoryList(o)}};1<e&&a.bootstrapPaginator(o)},getUpdateCodeHistoryList=function(e){void 0===e&&(e=1);var a=0;Cy.ajax("/algorithm/live/getLiveHistoryList?backtestId="+backtestId+"&page="+e+"&limit=20",{fail:function(t){throw t},error:function(t){throw t},success:function(t){if("00000"!==t.code)return BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:t.msg}),!1;totalCount=parseInt(t.data.totalCount),a=Math.ceil(totalCount/20),$(".historyCodeList").html(Mustache.render('<table class="table"            id="algo_table">              <thead>                <tr>                  <td class="align-left">操作时间</td>                  <td class="align-left">操作方式</td>                  <td class="align-left">备注</td>                  <td class="tright">代码</td>                </tr>              </thead>              <tbody>                {{#list}}                  <tr class="algorithm_list">                    <td class="align-left">                      {{addTime}}                    </td>                    <td class="align-left">                      {{#showType}}                        修改                      {{/showType}}                      {{^showType}}                        替换                      {{/showType}}\t\t\t\t\t</td>\t\t\t\t\t<td class="align-left">\t\t\t\t\t\t<span class="before-empty-null">{{introduce}}</span>\t\t\t\t\t\t<span class="change-history-id-remark edit-icon" title="点击备注" data-historyid="{{liveHistoryId}}" data-remark="{{introduce}}"></span>\t\t\t\t\t</td>                    <td class="tright">                      <a href="javascript: void(0);"                        class="history-code"                        history-type="{{getCodeType}}"                        backtest-id="{{sourceBacktestId}}"                        live-history-id="{{liveHistoryId}}">                        查看                      </a>                      {{#code}}                        <input type="hidden" value="{{code}}" />                      {{/code}}                    </td>                  </tr>                {{/list}}              </tbody>            </table>',t.data)),renderPage(e,a)}})},onShowHistoryCodeDialog=function(t){var o=$(this);BootstrapDialog.show({title:"历史策略代码",btnOKLabel:"确认",cssClass:"code-dialog",message:"",onshown:function(t){if("0"===o.attr("history-type")){var e=o.attr("backtest-id");Cy.ajax("/algorithm/backtest/source",{async:!1,data:{backtestId:e},success:function(t){if("00000"!==t.code)BootstrapDialog.alert(t.msg);else{var e=$(".bootstrap-dialog-message").eq(0);e.attr("id","history-code-view");var a=.7*$("body").height();e.css("height",a+"px"),e.text(t.data.source),$(".code-dialog .modal-dialog").css("width","700px");var o=ace.edit("history-code-view");o.session.setMode("ace/mode/python"),o.setTheme("ace/theme/tomorrow")}}})}else{var a=o.attr("live-history-id");Cy.ajax("/algorithm/live/getLiveHistoryCode",{type:"GET",async:!1,data:{liveHistoryId:a},success:function(t){if("00000"!==t.code)BootstrapDialog.alert(t.msg);else{var e=$(".bootstrap-dialog-message").eq(0);e.attr("id","history-code-view");var a=.7*$("body").height();e.css("height",a+"px"),e.text(t.data.source),$(".code-dialog .modal-dialog").css("width","700px");var o=ace.edit("history-code-view");o.session.setMode("ace/mode/python"),o.setTheme("ace/theme/tomorrow")}}})}},data:{id:"code-dialog"}})},initPage=function(){getUpdateCodeHistoryList(1)},drawResult=function(t){Cy.ajax("/algorithm/backtest/result?backtestId="+t+"&offset="+resultOffset,{fail:function(){stopResult=!0},error:function(t){stopResult=!0},success:function(t){var e,a,o,i,n=t.data.userRecord;if(status=t.data.state,0==t.data.state)return stopResult=!1;if(3==t.data.state)return failFlag=!0,stopResult=!0,$("#tradeTime").html('<span class="tips" >运行出错</span>'),BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"运行失败，详情请查看日志"}),!1;if(o=t.data.result.benchmark,i=t.data.result.overallReturn,n=t.data.userRecord,(a=t.data.result.count)<=0&&2!=t.data.state)stopResult=!1;else{e=i.value[a-1].toFixed(2),drawExcessResult={time:[],value:[]};for(var s=0;s<i.time.length;s++)drawExcessResult.time.push(i.time[s]),drawExcessResult.value.push((i.value[s]+100)/(o.value[s]+100)*100-100);updateTotalReturn(e),draw(i,o,drawexcessResult,n),stopResult=!1}}})},addPoint=function(t,e){for(var a=0;a<e.time.length;a++){var o=e.time[a],i=e.value[a];t.addPoint([o,i],!1,!1)}},draw=function(t,e,a,o){var i=2;if(chart=chart&&newChart(o),addPoint(chart.series[0],t),addPoint(chart.series[1],e),addPoint(chart.series[2],a),o)for(var n in o)$.isArray(o[n])&&(addPoint(chart.series[i],o[n]),i++);chart.redraw()},drawdayChart=function(t,e){daychart=daychart||dayChart(),addPoint(daychart.series[0],t),addPoint(daychart.series[1],e),daychart.redraw()},clearHighchartLable=function(){$("text[text-anchor=end]").each(function(){"Highcharts.com"==this.innerHTML&&$(this).remove()})},newChart=function(t){var e=[{type:"area",name:"策略收益",id:"overallReturn",color:"#4572A7",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d %H:%M,%A"},valueDecimals:2,valueSuffix:"%"},fillOpacity:.2,data:[]},{name:"基准收益",color:"#aa4643",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d %H:%M,%A"},valueDecimals:2,valueSuffix:"%"},data:[]},{name:"超额收益",visible:!1,color:"#FFA042",id:"excessSeries",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},valueDecimals:2,valueSuffix:"%"},data:[]}];if(t){for(var a in 16,60,t)e.push({name:a,data:[],yAxis:1});var o=[{height:"45%",lineWidth:2,title:{text:"累计收益"},tickPixelInterval:30,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],labels:{align:"right",x:-3,formatter:function(){return this.value+"%"}}},{labels:{align:"right",x:-3},title:{text:"自定义数据"},tickPixelInterval:30,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],top:"50%",height:"45%",offset:0,lineWidth:2}]}else{26,40;o=[{height:"90%",lineWidth:2,title:{text:"累计收益"},tickPixelInterval:30,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],labels:{align:"right",x:-3,formatter:function(){return this.value+"%"}}}]}return chart=new Highcharts.StockChart({chart:{renderTo:"historical_earnings",events:{tooltipRefresh:function(t){chartHoverPointIndex=chart.hoverPoints[0].index},click:function(t){if("day"!=frequency)if(1==chartClick){var e=new Date(t.xAxis[0].value);e=e.toLocaleString(),$("#modal_chart").addClass("in").css({display:"block"}),initdayResult(e,"bootchart"),$("#modal_chart").find(".modal-title").html(e+"收益走势"),chartClick=0}else chartClick++}},animation:Highcharts.svg,marginRight:22},credits:{enabled:!1},exporting:{enabled:!1},scrollbar:{enabled:!1},legend:{enabled:!1,floating:!0,align:"left",verticalAlign:"top",squareSymbol:!1,symbolHeight:10,symbolWidth:10,itemDistance:10,x:230,y:-3},colors:["#89A54E","#80699B","#18a5ca","#DB843D","#A47D7C"],title:{text:""},rangeSelector:{buttons:[{type:"week",count:1,text:"1星期"},{type:"month",count:1,text:"1个月"},{type:"month",count:6,text:"6个月"},{type:"month",count:12,text:"1年"},{type:"all",text:"全部"}],inputEnabled:!1,inputDateFormat:"%Y-%m-%d",selected:4},plotOptions:{series:{turboThreshold:0,connectNulls:!0,marker:{states:{hover:{enabled:!0,radius:4}},symbol:"circle"},animation:!1,point:{events:{click:function(){if("day"!=frequency)if(1==pointClick){var t=new Date(this.x);t=t.toLocaleString(),$("#modal_chart").addClass("in").css({display:"block"}),initdayResult(t,"bootchart"),$("#modal_chart").find(".modal-title").html(t+"收益走势"),pointClick=0}else pointClick++}}}}},navigator:{series:{color:"transparent",lineWidth:0},height:20,maskFill:"rgba(180, 198, 220, 0.75)",xAxis:{type:"datetime",labels:{formatter:function(){return Highcharts.dateFormat("%y-%m-%d",this.value)}}}},xAxis:{gridLineWidth:1,gridLineColor:"lightgray",categories:[],type:"datetime",tickPixelInterval:150,labels:{style:{fontSize:"10px"},formatter:function(){return Highcharts.dateFormat("%y-%m-%d %H:%M",this.value)}},events:{setExtremes:function(t){isInitFlag||"rangeSelectorButton"!==t.trigger?"rangeSelectorButton"!=t.trigger&&("navigator"!==t.trigger||"mouseup"!==t.DOMEvent.type&&"touchend"!==t.DOMEvent.type)||onGetResetData(t,dataResult):isInitFlag=!0}}},yAxis:o,series:e,credits:{enabled:!1}})},dayChart=function(){return daychart=new Highcharts.StockChart({chart:{renderTo:"today_earnings",animation:Highcharts.svg,marginRight:22},credits:{enabled:!1},exporting:{enabled:!1},scrollbar:{enabled:!1},colors:["#89A54E","#80699B","#18a5ca","#DB843D","#A47D7C"],legend:{enabled:!1,align:"left",verticalAlign:"top",squareSymbol:!0,symbolHeight:10,symbolWidth:10,itemDistance:10},rangeSelector:{enabled:!1},plotOptions:{series:{turboThreshold:0,connectNulls:!0,marker:{states:{hover:{enabled:!0,radius:4}},symbol:"circle"},animation:!1}},navigator:{series:{color:"transparent",lineWidth:0},height:20,maskFill:"rgba(180, 198, 220, 0.75)",xAxis:{type:"datetime",labels:{formatter:function(){return Highcharts.dateFormat("%y-%m-%d",this.value)}}}},xAxis:{gridLineWidth:1,gridLineColor:"lightgray",categories:[],type:"datetime",tickPixelInterval:100,labels:{style:{fontSize:"10px"},formatter:function(){return Highcharts.dateFormat("%H:%M",this.value)}}},yAxis:[{height:"90%",lineWidth:2,title:{text:"累计收益"},tickPixelInterval:30,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],labels:{align:"right",x:-3,formatter:function(){return this.value+"%"}}}],series:[{type:"area",name:"策略收益",color:"#4572A7",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d %H:%M,%A"},valueDecimals:2,valueSuffix:"%"},fillOpacity:.2,data:[]},{name:"基准收益",color:"#aa4643",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d %H:%M,%A"},valueDecimals:2,valueSuffix:"%"},data:[]},{name:"超额收益",visible:!1,color:"#FFA042",id:"excessSeries",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},valueDecimals:2,valueSuffix:"%"},data:[]}]})},dayBootChart=function(){return bootchart=new Highcharts.StockChart({chart:{renderTo:"onDayGains_chart",animation:Highcharts.svg,marginRight:22},credits:{enabled:!1},exporting:{enabled:!1},scrollbar:{enabled:!1},colors:["#89A54E","#80699B","#18a5ca","#DB843D","#A47D7C"],legend:{enabled:!1,align:"left",verticalAlign:"top",squareSymbol:!0,symbolHeight:10,symbolWidth:10,itemDistance:10},rangeSelector:{enabled:!1},plotOptions:{series:{turboThreshold:0,connectNulls:!0,marker:{states:{hover:{enabled:!0,radius:4}},symbol:"circle"},animation:!1}},navigator:{series:{color:"transparent",lineWidth:0},height:20,maskFill:"rgba(180, 198, 220, 0.75)",xAxis:{type:"datetime",dateTimeLabelFormats:{day:"%Y-%m-%d"}}},xAxis:{gridLineWidth:1,gridLineColor:"lightgray",categories:[],type:"datetime",tickPixelInterval:50,labels:{style:{fontSize:"10px"},formatter:function(){return Highcharts.dateFormat("%H:%M",this.value)}}},yAxis:[{height:"90%",lineWidth:2,title:{text:"累计收益"},tickPixelInterval:30,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],labels:{align:"right",x:-3,formatter:function(){return this.value+"%"}}}],series:[{type:"area",name:"策略收益",color:"#4572A7",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d %H:%M,%A"},valueDecimals:2,valueSuffix:"%"},fillOpacity:.2,data:[]},{name:"基准收益",color:"#aa4643",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d %H:%M,%A"},valueDecimals:2,valueSuffix:"%"},data:[]}]})},initdayResult=function(t,r){"day"!=frequency&&Cy.ajax("/algorithm/backtest/dayResult?backtestId="+backtestId+"&date="+t,{fail:function(){},error:function(t){},success:function(t){if("daychart"==r)var e="today_earnings";else e="onDayGains_chart";if(0!=t.data.state){var a=t.data.result.count,o=parseInt(t.data.result.offset),i={},n={};daydataResult=[],daydatabenchmark=[];for(var s=0;s<a;s++)daydataResult[s+o]={},daydataResult[s+o].x=t.data.result.overallReturn.time[s],daydataResult[s+o].y=t.data.result.overallReturn.value[s],daydatabenchmark[s+o]={},daydatabenchmark[s+o].x=t.data.result.benchmark.time[s],daydatabenchmark[s+o].y=t.data.result.benchmark.value[s],i[t.data.result.benchmark.time[s]]=s+o,t.data.result.benchmark.time[s];return resultOffset=o+a,void(0<daydataResult.length?("daychart"==r?(dayExcessResult=initChartData(daychart,dayChart,daydataResult,daydatabenchmark,null,!0),n=daychart):"bootchart"==r&&(bootExcessResult=initChartData(bootchart,dayBootChart,daydataResult,daydatabenchmark,null,!1),n=bootchart),n.redraw(),clearHighchartLable()):$("#"+e).html('<p style="padding:20px;">暂无数据</p>'))}$("#"+e).html('<p style="padding:10px;">未开始，暂无数据</p>')}})},dayResult=function(){if(stopdayResult=!0,"day"===frequency)return!1;Cy.ajax("/algorithm/backtest/dayResult?backtestId="+backtestId+"&date="+lastDay,{fail:function(){stopdayResult=!1},error:function(t){stopdayResult=!1},success:function(t){if(status=t.data.state,0!=t.data.state){if(3==t.data.state)return failFlag=!0,$("#tradeTime").html("<span class='tips'>运行出错</span>"),void BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"运行失败，详情请查看日志"});var e=t.data.result.count;stopdayResult=(e<=0&&2!=t.data.state||drawdayChart(t.data.result.overallReturn,t.data.result.benchmark),!1)}else stopdayResult=!1}})},chartKeydown=function(t){var e=chart;if(e){var a=e.series[0].points.length;switch(t.keyCode){case 37:0==chartHoverPointIndex?chartHoverPointIndex=chartHoverPointIndex:chartHoverPointIndex-=1;for(var o=[],i=0;i<e.series.length;i++)o[i]=e.series[i].points[chartHoverPointIndex];e.tooltip.refresh(o);break;case 39:chartHoverPointIndex==a?chartHoverPointIndex=chartHoverPointIndex:chartHoverPointIndex+=1;for(o=[],i=0;i<e.series.length;i++)o[i]=e.series[i].points[chartHoverPointIndex];e.tooltip.refresh(o)}}},lastPositionQuery={},getPosition=function(t,e){void 0!==t&&(lastPositionQuery.date=t),void 0!==e&&(lastPositionQuery.isForward=e),e=e||0,Cy.ajax("/algorithm/live/position?limit=50&backtestId="+backtestId+"&date="+lastPositionQuery.date+"&isForward="+lastPositionQuery.isForward+"&field="+positionInfoSort.field+"&order="+positionInfoSort.order,{error:function(t){},fail:function(t){},success:function(t){if(positionGrid=drawPositioninfo(t.data.position,t.data.isLimit),$("#positionCount").html("("+t.data.position.length+")"),fillDataFlag){$("#available_cash").html("&#65509;"+t.data.cash),$("#total_cash").html("&#65509;"+t.data.totalValue);var e=(100*(1-t.data.cash/t.data.totalValue)).toFixed(2);$("#count_position").html(e+"%"),fillDataFlag=!1}}})},parseValue=function(t,e){return t?"number"==typeof t&&(t=(t*=100).toFixed(2)+"%"):t="",t},positionInfoSort={field:"",order:""},drawPositioninfo=function(t,o){if($("body").hasClass("mobile"))e=["名称/代码","盈亏/多空","成本/现价","可用/持仓"],a=[{name:"stock",index:"stock",align:"center",sorttype:function(t,e){return'<span class="label label-cash">Cash</span>'==t?"*"+t:t}},{name:"gain",index:"gain",align:"center",sorttype:"float",formatter:function(t,e,a){return t+"<br/>"+a.side}},{name:"avgCost",index:"avgCost",align:"center",sorttype:"float",formatter:function(t,e,a){return t+"<br/>"+a.price}},{name:"closeableAmount",index:"closeableAmount",align:"center",sorttype:"float",formatter:function(t,e,a){return t+"<br/>"+a.amount}}],i={gain:1,closeableAmount:1,stock:1,avgCost:1};else var e=["品种","标的","多空","数量","可用数量","现价","市值/价值","盈亏","逐笔浮盈","开仓均价","持仓均价(期货)","保证金","当日盈亏","今手数","仓位占比","盈亏占比"],a=[{name:"security",index:"security",align:"center"},{name:"stock",index:"stock",align:"center",sorttype:function(t,e){return'<span class="label label-cash">Cash</span>'==t?"*"+t:t}},{name:"side",index:"side",align:"center"},{name:"amount",index:"amount",align:"center",sorttype:"float"},{name:"closeableAmount",index:"closeableAmount",align:"center",sorttype:"float"},{name:"price",index:"price",align:"center",sorttype:"float"},{name:"value",index:"value",align:"center",sorttype:"float"},{name:"gain",index:"gain",align:"center",sorttype:"float"},{name:"gainPercent",index:"gainPercent",align:"center",sorttype:"float",formatter:function(t,e,a){return parseValue(a.gainPercent)}},{name:"avgCost",index:"avgCost",align:"center",sorttype:"float"},{name:"holdCost",index:"holdCost",align:"center",sorttype:"float"},{name:"margin",index:"margin",align:"center",sorttype:"float"},{name:"dailyGains",index:"dailyGains",align:"center",sorttype:"float"},{name:"todayAmount",index:"todayAmount",align:"center",sorttype:"float"},{name:"positionPersent",index:"positionPersent",align:"center",formatter:function(t,e,a){return t=t?parseFloat(t.split("%")[0]).toFixed(2)+"%":""},sorttype:function(t){return parseFloat(t)}},{name:"dailyGainsPercent",index:"dailyGainsPercent",align:"center",formatter:function(t,e,a){return parseValue(t)}}],i={date:1,time:1,stock:1};var n=$.cookie("live_default_position_cols");n&&0<n.length&&(positionDisplayCols=n.split(","));for(var s={},r=0;r<positionDisplayCols.length;r++)s[positionDisplayCols[r]]=1;for(r=0;r<a.length;r++)s[a[r].index]||i[a[r].index]||(a[r].hidden=!0);var l=$("#positioninfo").parents(".ui-jqgrid-bdiv").scrollTop();$("#positioninfo").jqGrid("GridUnload"),$("#positioninfo").jqGrid({autowidth:!0,shrinkToFit:!0,data:t,datatype:"local",height:240,rowNum:1e4,colNames:e,colModel:a,sortname:positionInfoSort.field,sortorder:positionInfoSort.order,viewrecords:!0,hidegrid:!1,altRows:!0,caption:null,loadComplete:function(){$(this).find("tfoot").remove(),o&&$(this).append(moreTFoot),l&&$("#positioninfo").parents(".ui-jqgrid-bdiv").scrollTo(l)},onSortCol:function(t,e,a){if(positionInfoSort.field=t,positionInfoSort.order=a,o)return getPosition(),"stop"}}),positionTdWidth=$("#positioninfo").getGridParam("width");var d="",c="";for(r=0;r<e.length;r++)i[a[r].index]||(c=s[a[r].index]?"checked":"",d=d+' <div class="checkbox"><label><input type="checkbox" name="position-select" value="'+a[r].index+'" '+c+">"+e[r]+"</label></div>");return $("#position-column-select").html(d),$("#positioninfo")},lastTransactioQueryDate="",getTransaction=function(t){lastTransactioQueryDate=t||lastTransactioQueryDate,Cy.ajax("/algorithm/live/transactionDetail?limit=200&backtestId="+backtestId+"&date="+lastTransactioQueryDate+"&field="+transactionInfoSort.field+"&order="+transactionInfoSort.order,{error:function(t){},fail:function(t){},success:function(t){transactionGrid=drawTransactioninfo(t.data.transaction,t.data.isLimit)}})},transactionInfoSort={field:"",order:""},drawTransactioninfo=function(t,o){if($("body").hasClass("mobile"))e=["名称/代码","成交均价/数量","成交时间","交易类型/状态"],a=[{name:"stock",index:"stock",align:"center"},{name:"price",index:"price",align:"center",sortable:!1,sorttype:"float",formatter:function(t,e,a){return t+"<br/>"+a.amount}},{name:"time",index:"time",align:"center",sortable:!1,formatter:function(t,e,a){return a.date+"<br/>"+t}},{name:"transaction",index:"transaction",align:"center",sortable:!1,sorttype:!1,formatter:function(t,e,a){return t+"<br/>"+a.status}}],i={stock:1,date:1,time:1,transaction:1};else var e=["日期","委托时间","品种","标的","交易类型","下单类型","成交数量","成交价","委托数量","委托价格","状态","成交额","平仓盈亏","手续费","最后更新时间"],a=[{name:"date",index:"date",align:"center"},{name:"time",index:"time",align:"center"},{name:"security",index:"security",align:"center"},{name:"stock",index:"stock",align:"center"},{name:"transaction",index:"transaction",align:"center",sorttype:!1},{name:"type",index:"type",align:"center",sorttype:!1},{name:"amount",index:"amount",align:"center",sorttype:function(t,e){return parseInt(t.replace(/[^-|0-9]/gi,""))}},{name:"price",index:"price",align:"center",sorttype:"float"},{name:"orderAmount",index:"orderAmount",align:"center",sorttype:function(t,e){return parseInt(t.replace(/[^-|0-9]/gi,""))}},{name:"limitPrice",index:"limitPrice",align:"center",sorttype:"float"},{name:"status",index:"status",align:"center",sorttype:"float"},{name:"total",index:"total",align:"center",sorttype:"float"},{name:"gains",index:"gains",align:"center",sorttype:"float"},{name:"commission",index:"commission",align:"center",sorttype:"float"},{name:"matchTime",index:"matchTime",align:"center",sorttype:"date",formatter:"date",formatoptions:{srcformat:"Y-m-d H:i:s",newformat:"Y-m-d H:i:s"}}],i={stock:1,date:1,time:1};var n=$.cookie("live_default_transaction_cols");n&&0<n.length&&(transactionDisplayCols=n.split(","));for(var s={},r=0;r<transactionDisplayCols.length;r++)s[transactionDisplayCols[r]]=1;for(r=0;r<a.length;r++)s[a[r].index]||i[a[r].index]||(a[r].hidden=!0);var l=$("#transactioninfo").parents(".ui-jqgrid-bdiv").scrollTop();$("#transactioninfo").jqGrid("GridUnload"),$("#transactioninfo").jqGrid({autowidth:!0,shrinkToFit:!0,data:t,datatype:"local",height:240,rowNum:1e4,colNames:e,colModel:a,sortname:transactionInfoSort.field,sortorder:transactionInfoSort.order,viewrecords:!0,hidegrid:!1,altRows:!0,caption:null,loadComplete:function(){$(this).find("tfoot").remove(),o&&$(this).append(moreTFoot),l&&(console.log("scrollTop",l),$("#transactioninfo").parents(".ui-jqgrid-bdiv").scrollTo(l))},onSortCol:function(t,e,a){if(console.log(t,e,a),transactionInfoSort.field=t,transactionInfoSort.order=a,o)return getTransaction(),"stop"}}),transactionTdWidth=$("#transactioninfo").getGridParam("width");var d="",c="";for(r=0;r<e.length;r++)i[a[r].index]||(d=s[a[r].index]?"checked":"",c=c+' <div class="checkbox"><label><input type="checkbox" name="transaction-select" value="'+a[r].index+'" '+d+">"+e[r]+"</label></div>");return $("#transaction-column-select").html(c),$("#transactioninfo")},initStat=function(n,s){Cy.ajax("/algorithm/live/stat?backtestId="+n+"&offset="+statOffset,{error:function(t){},success:function(t){if(0!=t.data.state){var e=t.data.count;if(e<=0){if(statRecord.alpha&&0<statRecord.alpha.length){chartStat=newChartStat();var a=0;for(var o in t.data.stat)chartStat.series[a]&&(chartStat.series[a].setData(statRecord[o],!1),a++);clearHighchartLable(),chartStat.redraw()}else $("#stat-chart").html('<p style="padding:10px">暂无数据</p>');s()}else{var i=parseInt(t.data.offset);for(a=0;a<e;a++)for(var o in t.data.stat)statRecord[o]||(statRecord[o]=[]),statRecord[o][a+i]={},statRecord[o][a+i].x=t.data.stat[o].time[a],statRecord[o][a+i].y=t.data.stat[o].value[a];statOffset=i+e,$("#avg_excess_return").text(t.data.stat.avg_excess_return.value[0]||"--"),$("#excess_return_max_drawdown").text(t.data.stat.excess_return_max_drawdown.value[0]||"--"),$("#excess_return_sharpe").text(t.data.stat.excess_return_sharpe.value[0]||"--"),initStat(n,s)}}}})},drawStat=function(t){stopStat||(stopStat=!0,Cy.ajax("/algorithm/live/stat?backtestId="+t+"&offset="+statOffset,{error:function(t){},fail:function(t){},success:function(t){if(0!=t.data.state&&3!=t.data.state){var e=t.data.count;stopStat=(e<=0&&2!=t.data.state||($("#avg_excess_return").text(t.data.stat.avg_excess_return.value[0]||"--"),$("#excess_return_max_drawdown").text(t.data.stat.excess_return_max_drawdown.value[0]||"--"),$("#excess_return_sharpe").text(t.data.stat.excess_return_sharpe.value[0]||"--"),draw2(t.data.stat)),!1)}}}))},draw2=function(t){chartStat=chartStat||newChartStat();var e=0;for(var a in t)addPoint(chartStat.series[e],t[a]),e++;chartStat.redraw()},newChartStat=function(t){for(var e=["Alpha","Beta","Sharpe","Sortino Ratio","Information Ratio","Volatility"],a=[],o=[],i=parseInt(($("#stat-chart").height()-100)/e.length)-30,n=0;n<e.length;n++){a.push({name:e[n],tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d %H:%M,%A"},valueDecimals:2,valueSuffix:"%"},fillOpacity:.2,yAxis:n,data:[]});var s=n*(28+i)+28+8;o.push({labels:{align:"right",x:-3,formatter:function(){return this.value+"%"}},title:{text:e[n]},tickPixelInterval:50,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,plotLines:[{value:0,color:"black",width:2}],top:s,height:i,offset:0,lineWidth:2})}return chartStat=new Highcharts.StockChart({chart:{renderTo:"stat-chart",events:{tooltipRefresh:function(t){chartStatHoverPointIndex=chartStat.hoverPoints[0].index}},animation:Highcharts.svg,marginRight:22},credits:{enabled:!1},exporting:{enabled:!1},scrollbar:{enabled:!1},colors:["#89A54E","#80699B","#18a5ca","#DB843D","#A47D7C"],title:{text:""},rangeSelector:{buttons:[{type:"week",count:1,text:"1星期"},{type:"month",count:1,text:"1个月"},{type:"month",count:6,text:"6个月"},{type:"month",count:12,text:"1年"},{type:"all",text:"全部"}],inputEnabled:!1,inputDateFormat:"%Y-%m-%d",selected:4},plotOptions:{series:{turboThreshold:0,marker:{states:{hover:{enabled:!0,radius:4}},symbol:"circle"},animation:!1}},navigator:{series:{color:"transparent",lineWidth:0},height:20,maskFill:"rgba(180, 198, 220, 0.75)",xAxis:{type:"datetime",labels:{formatter:function(){return Highcharts.dateFormat("%y-%m-%d",this.value)}}}},xAxis:{gridLineWidth:1,gridLineColor:"lightgray",categories:[],type:"datetime",tickPixelInterval:150,labels:{style:{fontSize:"10px"},formatter:function(){return Highcharts.dateFormat("%y-%m-%d %H:%M",this.value)}}},yAxis:o,series:a})},chartStatKeydown=function(t){var e=chartStat,a=e.series[0].points.length;switch(t.keyCode){case 37:0==chartStatHoverPointIndex?chartStatHoverPointIndex=chartStatHoverPointIndex:chartStatHoverPointIndex-=1;for(var o=[],i=0;i<e.series.length;i++)o[i]=e.series[i].points[chartStatHoverPointIndex];e.tooltip.refresh(o);break;case 39:chartStatHoverPointIndex==a?chartStatHoverPointIndex=chartStatHoverPointIndex:chartStatHoverPointIndex+=1;for(o=[],i=0;i<e.series.length;i++)o[i]=e.series[i].points[chartStatHoverPointIndex];e.tooltip.refresh(o)}},getSourceCode=function($dom){if("0"==$dom.attr("_isLoad"))if(1==accessControl){if(!g_isWinApp||"undefined"==typeof jsObj)return"#请在客户端打开查看源码";var backtestId=$("#source-backtest").attr("sourceBacktestId_"),res=jsObj.ReadBacktestCode(backtestId),obj=eval("("+res+")");if("00000"!=obj.code)return"#无法查看源码"+obj.msg;$dom.text(obj.data)}else{var id=$dom.attr("_backtestId");Cy.ajax("/algorithm/backtest/source",{async:!1,data:{backtestId:id},success:function(t){"00000"!==t.code?BootstrapDialog.alert(t.msg):($dom.text(t.data.source),$dom.attr("_isLoad","1"),algorithmCode=t.data.source,$(".live__algorithm-code-edter-btns_operation").removeClass("hidden"))}})}return $dom.text()},drawCode=function(t){getSourceCode($("#code-view")),(editor=ace.edit("code-view")).session.setMode("ace/mode/python"),editor.setTheme("ace/theme/tomorrow"),editor.setReadOnly(!0),$(t).attr("_hasDrawn",1)},updateBacktestList=function(t,n){Cy.ajax(t,{success:function(t){if("0"!=t.status)return Cy.alert(t.msg),void layer.find(".close").click();for(var e="",a="<option>Python2</option>",o=0;o<t.data.length;o++){if(t.data[o].pyVersion||(t.data[o].pyVersion="2"),t.data[o].uniqueCode==n){var i="selected";t.data[o].pyVersion&&(a="<option>Python"+t.data[o].pyVersion+"</option>")}else i="";e+="<option data-pyVersion='"+t.data[o].pyVersion+"' value='"+t.data[o].backtestId+"' _uniqueCode='"+t.data[o].uniqueCode+"' "+i+">"+t.data[o].name+" - "+(100*t.data[o].overallReturn).toFixed(2)+"%</option>\n"}$(".community-backtest-select-dialog").find("#backtest").html(e),$(".community-backtest-select-dialog").find("#pyVersion").html(a),$(".community-backtest-select-dialog").find("select").selectpicker("refresh")}})},pythonVersionChange=function(){var t=$(this),e="<option>Python"+t.find('option[value="'+t.val()+'"]').attr("data-pyVersion")+"</option>";$(".community-backtest-select-dialog").find("#pyVersion").html(e).selectpicker("refresh")},toSubmitNewName=function(t){Cy.ajax("/algorithm/backtest/setName",{data:"backtestId="+backtestId+"&name="+t,success:function(t){}})},updateTotalReturn=function(t){$("#total_returns").html(t+"%"),t<0?($("#total_returns").parent().removeClass("money_red"),$("#total_returns").parent().addClass("money_green")):($("#total_returns").parent().removeClass("money_green"),$("#total_returns").parent().addClass("money_red")),$("title").html(t+"% "+$(".backtest_name").html())},getjiaoyi=function(t){$("#pane_jiaoyi .widget-body").html(""),Cy.ajax("/algorithm/live/transactionDetail?backtestId="+backtestId+"&date="+t,{success:function(a){$(a.data.transaction).each(function(t,e){a.data.transaction[t];$("#pane_jiaoyi .widget-body").append(function(){return'<div class="widget-table"><h4 class="time">'+e.date+"&nbsp;&nbsp;"+e.time+'</h4><table id="Mo-jiaoyi"><tr class="title"><td>股票名称/代码</td><td>成交均价/数量</td><td>交易类型/状态</td></tr><tr><td>'+e.stock+"</td><td>"+e.price+"<br>"+e.amount+"</td><td>"+e.transaction+"<br>"+e.status+"</td></tr></table></div>"})})}})},getchic=function(t){$("#pane_chic .widget-body").html(""),Cy.ajax("/algorithm/live/position?backtestId="+backtestId+"&date="+t,{success:function(t){$(t.data.position).each(function(t,e){$("#pane_chic .widget-body").append(function(){return'<div class="widget-table"><h4 class="name">'+e.stock+'</h4><table id="Mo-chic"><tr class="title"><td>盈亏/多空</td><td>成本/现价</td><td>可用/持仓</td><td>市值/今手数</td></tr><tr><td>'+e.gain+"<br>"+e.side+"</td><td>"+e.avgCost+"<br>"+e.price+"</td><td>"+e.closeableAmount+"<br>"+e.amount+"</td><td>"+e.value+"<br>"+e.todayAmount+"</td></tr></table></div>"})})}})},WH=function(){if(g_isMobile){var t=$(window).width();t-265<$("#backtest_name").width()&&$("#backtest_name").width(t-265),$(window).scrollTop(0)}else $(".alg_live_body .mainpane .pane-container").scrollTop(0)},getCookie=function(t){var e,a=new RegExp("(^| )"+t+"=([^;]*)(;|$)");return(e=document.cookie.match(a))?unescape(e[2]):null},tips=function(){getCookie("tips")||g_isMobile||$(".ftips").removeClass("hidden")},switchFlagFun=function(t){t?$(".msg-switch").bootstrapSwitch("state",!0):$(".msg-switch").bootstrapSwitch("state",!1)},shareLinkFun=function(){switchFlag||BootstrapDialog.show({title:"链接分享",cssClass:"shareLink__dialog",message:'<p class="shareLink__dialog-title">分享后其他用户可以通过链接与密码访问该模拟交易</p> <p class="shareLink__dialog-text">1.分享页面不包含<span>“代码”</span>、<span>“设置”</span>内容。</p> <p class="shareLink__dialog-text">2.您可在<span>“设置”</span>中查看分享链接，并取消链接分享。</p>',buttons:[{label:"取消",cssClass:"shareLink__dialog-cancel",action:function(t){t.close(),switchFlagFun()}},{label:"创建链接",cssClass:"shareLink__dialog-sure",action:function(t){t.close(),t.switchFlag=!0,switchFlag=!0,getLinkDialog(),switchFlagFun(!0)}}],onhidden:function(t){t.switchFlag||(switchFlagFun(),switchFlag=!1)}})},getLinkDialog=function(){Cy.ajax("/algorithm/live/submitShareUrl",{data:{backtestId:backtestId},type:"GET",success:function(t){var a=$("#backtest_name").html(),o=g_domain+"/algorithm/live/liveUrlShareIndex?backtestId="+backtestId,i=t.data.code;BootstrapDialog.show({title:"分享链接",cssClass:"getShareLink__dialog",message:'<p class="getShareLink__dialog-title">链接创建成功</p> <p class="getShareLink__dialog-text">可通过QQ、微信、雪球、微博等分享给好友</p> <p class="getShareLink__dialog-linkpass"><span class="getShareLink__dialog-linkpass-text">链接</span><input type="text" class="getShareLink__dialog-linkpass-input link" value="'+o+'"></p> <p class="getShareLink__dialog-linkpass"><span class="getShareLink__dialog-linkpass-text">密码</span><input type="text" class="getShareLink__dialog-linkpass-input password" value="'+i+'"></p><div class="tcenter getShareLink__dialog-btn"><input id="foo" class="getShareLink__dialog-foo" type="text" value=""><button class="getShareLink__dialog-copy" data-clipboard-action="copy" data-clipboard-target="#foo">复制链接及密码</button></div>',onshown:function(e){var t="【JoinQuant】策略名称："+a+"  链接："+o+"  密码："+i;$(".getShareLink__dialog-foo").val(t),new ClipboardJS(".getShareLink__dialog-copy").on("success",function(t){e.close(),clipboardHidden=!0,BootstrapDialog.show({title:"提示",message:'<p style="padding:20px 20px 0;">复制成功！</p>',onhidden:function(){window.location.reload()}})})},onhidden:function(){clipboardHidden||window.location.reload()}})},fail:function(t){}})},cancelShareLinkFun=function(){cancelSwitchFlag||BootstrapDialog.show({title:"提示",message:"确定取消链接分享？",cssClass:"cancelShareLink__dialog",buttons:[{label:"取消",cssClass:"cancelShareLink__dialog-cancel",action:function(t){t.close(),switchFlagFun(!0)}},{label:"确定",cssClass:"cancelShareLink__dialog-sure",action:function(e){Cy.ajax("/algorithm/live/cancelShareUrl?backtestId="+backtestId,{success:function(t){e.close(),switchFlagFun(),e.cancelSwitchFlag=!0,window.location.reload()}})}}],onhidden:function(t){t.cancelSwitchFlag||switchFlagFun(!0),cancelSwitchFlag=!1}})},getTradeTimeText=function(t){var e;switch(t=parseInt(t)){case 0:case 1:tradeTimeCheck(!0),$("#share-backtest-button").removeClass("hidden"),$("#putAway-backtest-button").removeClass("hidden"),setTimeout(tradeTimeCheck,3e4);break;case 2:e='<span class="tips" >已关闭</span>';break;case 3:e='<span class="tips" title="失败原因可以通过日志查看" >运行出错</span>';break;case 4:e='<span class="tips" >已关闭</span>';break;case 5:e='<span class="tips" >已暂停</span>'}e&&$("#tradeTime").html(e)},onToggleExcessData=function(){var t,e;"today"===this.dataset.type?(currentChart=daychart,currentExcessResult=dayExcessResult):(currentChart=chart,currentExcessResult=excessResult),flag||(addExcessMaxDrawdownTag(currentChart,calculateMaxDrawdown(excessResult)),flag=!0),t=currentChart.series[currentChart.series.length-1],e=currentChart.series[2],$(this).is(":checked")?(e.show(),t.show()):(e.hide(),t.hide()),currentChart.redraw()},addExcessMaxDrawdownTag=function(t,e){t.addSeries({type:"flags",data:[{x:e[0],title:" ",text:"最大回撤"},{x:e[1],title:" ",text:"最大回撤"}],onSeries:"excessSeries",fillColor:"#56d42a",states:{hover:{fillColor:"#56d42a"}},shape:"circlepin",y:-3,height:4,width:4})},calculateMaxDrawdown=function(t){var a,o,i,n,s,r;return t.map(function(t,e){(!a||t.y>a)&&(a=t.y,n=t.x),o=t.y-a,(!i||o<i)&&(i=o,s=t.x,r=[n,s])}),1-i,r},redrawChart=function(t,e,a,o){var i,n,s,r;i=t.filter(function(t,e){if(t.x===new Date(a).getTime())return e,t}),besicBenchmark=dataBenchmark.filter(function(t,e){if(t.x===new Date(a).getTime())return t}),e?i&&(i=i[0],n=t.map(function(t){return[t.x,t.y]}),s=dataBenchmark.map(function(t){return[t.x,t.y]}),r=excessResult.map(function(t){return[t.x,t.y]})):i&&(i=i[0],n=t.map(function(t){return[t.x,(t.y-i.y)/(100+i.y)*100]}),s=dataBenchmark.map(function(t){return[t.x,(t.y-besicBenchmark[0].y)/(100+besicBenchmark[0].y)*100]}),r=n.map(function(t,e){var a=s[e]||[];return[t[0],(t[1]+100)/(a[1]+100)*100-100]})),chart.series[0].setData(n,!1),chart.series[1].setData(s,!1),chart.series[2].setData(r,!1),chart.redraw()},onGetResetData=function(t,e){for(var a,o,i=[],n=!1,s=e,r=0;r<e.length;r++)i.push(e[r].x);a=getTick(i,t.min),o=getTick(i,t.max),a===e[0].x&&(n=!0,s=initDataResult,dataBenchmark=initDataBenchmark),redrawChart(s,n,a,o)},getTick=function(n,s){var r;return n.push(s),n.sort(),n.find(function(t,e){if(t===s){if(0===e)r=n[1];else if(e===n.length-1)r=n[n.length-1];else{var a=n[e+1],o=new Date(t).getDate(),i=new Date(a).getDate();o===i?r=n[e+2]:o!==i&&(r=a)}return!0}}),r},initChartData=function(t,e,a,o,i,n){var s=[],r=2;if(n){r=3;for(var l=0;l<o.length;l++)s.push({x:o[l].x,y:(a[l].y+100)/(o[l].y+100)*100-100})}(t=e(i)).series[0].setData(a,!1),t.series[1].setData(o,!1),s.length&&t.series[2].setData(s,!1);if(i)for(var d in i)t.series[r].setData(i[d],!1),r++;return s},parseDOM=function(){1<=monthStr&&monthStr<=9&&(monthStr="0"+monthStr),1<=strDate&&strDate<=9&&(strDate="0"+strDate),today=d.getFullYear()+"-"+monthStr+"-"+strDate,Date.prototype.toLocaleString=function(){var t=this.getMonth()+1,e=this.getDate();return t<=9&&(t="0"+t),e<=9&&(e="0"+e),this.getFullYear()+"-"+t+"-"+e},Highcharts.setOptions({global:{timezoneOffset:-480},lang:{months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],shortMonths:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],weekdays:["星期天","星期一","星期二","星期三","星期四","星期五","星期六"],rangeSelectorZoom:"缩放：",rangeSelectorFrom:"从",rangeSelectorTo:"到"}}),$("#position-date").datepicker({dateFormat:"yy-mm-dd",minDate:startDate,maxDate:lastDay,changeYear:!0,changeMonth:!0,beforeShow:function(){setTimeout(function(){$("#ui-datepicker-div").css("z-index",100007)},100)},onSelect:function(t,e){positionMod=t==lastDate?"today":"daily",$("body").hasClass("mobile")?(getchic(t),$("#position-titles").html("持仓详情("+t+")")):(getPosition(t,0),$("#position-title").html("持仓详情("+t+")"))}}),$("#transaction-date").datepicker({dateFormat:"yy-mm-dd",minDate:startDate,maxDate:lastDay,changeYear:!0,changeMonth:!0,beforeShow:function(){setTimeout(function(){$("#ui-datepicker-div").css("z-index",100007)},100)},onSelect:function(t,e){transactionMod=t==lastDate?"today":"daily",$("body").hasClass("mobile")?(getjiaoyi(t),$("#transaction-titles").html("交易详情("+t+")")):(getTransaction(t),$("#transaction-title").html("交易详情("+t+")"))}}),$(".popover-right").popover({placement:"bottom",trigger:"manual",html:!0,content:'风险指标有利于您对策略进行客观的评价，<a target="_blank" style="color:#337ab7;font-weight:normal" href="/api#%E9%A3%8E%E9%99%A9%E6%8C%87%E6%A0%87">查看计算公式</a>'}).on("mouseenter",function(){var t=this;$(this).popover("show"),$(this).siblings(".popover").on("mouseleave",function(){$(t).popover("hide")})}).on("mouseleave",function(){var t=this;setTimeout(function(){$(".popover:hover").length||$(t).popover("hide")},100)}),$(".msg-switch").bootstrapSwitch(),$("#applyShareUrl").removeClass("hidden"),newclipboard.on("success",function(){BootstrapDialog.show({title:"提示",message:'<p style="padding:20px 20px 0;">复制成功！</p>'})}),$("body").hasClass("mobile")&&($("#position-title").html("今日持仓("+today+")"),$("#transaction-title").html("今日下单("+today+")"))};$(".live__algorithm-code-replace-popover").popover({placement:"right",trigger:"manual",html:!0,content:'替换代码立即生效；g和context的变量不受影响；initialize不会再次执行，请使用after_code_changed修改；更多注意事项见<a target="_blank" href="/help/api/help?name=api#模拟盘注意事项">[模拟盘注意事项]</a>'}).on("mouseenter",function(){var t=this;$(this).popover("show"),$(this).siblings(".popover").on("mouseleave",function(){$(t).popover("hide")})}).on("mouseleave",function(){var t=this;setTimeout(function(){$(".popover:hover").length||$(t).popover("hide")},100)});var updateBacktestList1=function(t,i){Cy.ajax(t,{success:function(t){if("0"!=t.status)return Cy.alert(t.msg),void layer.find(".close").click();for(var e="",a=0;a<t.data.length;a++){if(t.data[a].uniqueCode==i)var o="selected";else o="";e+="<option value='"+t.data[a].backtestId+"' _uniqueCode='"+t.data[a].uniqueCode+"' "+o+">"+t.data[a].name+" - "+(100*t.data[a].overallReturn).toFixed(1)+"%</option>\n"}$(".updata-dialog").find("#backtestgx").html(e),$(".updata-dialog").find("select").selectpicker("refresh")}})},onPaneTrade=function(){$node.find(".pane-item").removeClass("active"),$node.find("#jiaoyi-item").addClass("active"),WH()},onPaneChic=function(){$node.find(".pane-item").removeClass("active"),$node.find("#chic-item").addClass("active"),WH()},onPaneItem=function(){return!!initDone&&(!$(this).hasClass("active")&&(WH(),$(".pane-item").removeClass("active"),$(this).addClass("active"),$(".mobile .topbar").addClass("hidden"),void("results"==$(this).attr("_pane")?$(".mobile .topbar").removeClass("hidden"):"logs"==$(this).attr("_pane")&&0==$(this).attr("_hasDrawn")?(stopErrorLog=stopLog=!1,fillLog()):"stats"==$(this).attr("_pane")?0==$(this).attr("_hasDrawn")&&initStat(backtestId,function(){stopStat=!1}):"code"==$(this).attr("_pane")&&(0==$(this).attr("_hasDrawn")?drawCode(this):setTimeout("editor.resize();editor.gotoLine(1);",500)))))},onPauseTrade=function(){var e=$(this);return e.hasClass("disabled")||BootstrapDialog.confirm("确定要暂停吗?",function(t){if(!t)return!1;e.addClass("disabled"),pause(function(){e.removeClass("disabled")})}),!1},onRestartTrade=function(){var e=$(this);if(e.hasClass("disabled"))return!1;BootstrapDialog.confirm("确定要重跑吗?",function(t){if(!t)return!1;e.addClass("disabled"),restart(function(){e.removeClass("disabled")})})},onResumeTrade=function(){var e=$(this);if($(this).hasClass("disabled"))return!1;BootstrapDialog.confirm("确定要重启吗?",function(t){if(!t)return!1;e.addClass("disabled"),resume(function(){e.removeClass("disabled")})})},onFinishTrade=function(){var e=$(this);if(e.hasClass("disabled"))return!1;BootstrapDialog.confirm("关闭后将无法再次开启，确定要关闭吗?",function(t){if(!t)return!1;e.addClass("disabled"),finish(function(){e.removeClass("disabled")})})},onSelectPositionColumn=function(){var t,e,a=$(this).val();if(this.checked)$node.find("#positioninfo").jqGrid("showCol",a),positionDisplayCols.push(a),e=positionDisplayCols.join(","),$.cookie("live_default_position_cols",e);else{$node.find("#positioninfo").jqGrid("hideCol",a);for(var o=0;o<positionDisplayCols.length;o++)if(positionDisplayCols[o]==a){t=o;break}t&&positionDisplayCols.splice(t,1),e=positionDisplayCols.join(","),$.cookie("live_default_position_cols",e)}$node.find("#positioninfo").setGridWidth(positionTdWidth)},onTransactionColumnSelect=function(){var t,e,a=$(this).val();if(this.checked)$node.find("#transactioninfo").jqGrid("showCol",a),transactionDisplayCols.push(a),e=transactionDisplayCols.join(","),$.cookie("live_default_transaction_cols",e);else{$node.find("#transactioninfo").jqGrid("hideCol",a);for(var o=0;o<transactionDisplayCols.length;o++)if(transactionDisplayCols[o]==a){t=o;break}t&&transactionDisplayCols.splice(t,1),e=transactionDisplayCols.join(","),$.cookie("live_default_transaction_cols",e)}$node.find("#transactioninfo").setGridWidth(transactionTdWidth)},onBacktestSelect=function(){BootstrapDialog.show({title:"替换代码",cssClass:"community-backtest-select-dialog",message:"",buttons:[{label:"确定",cssClass:"btn-primary",action:function(t){var e=$(".community-backtest-select-dialog").find("#backtest").parent().find('li[class="selected"]');if(0<e.length){var a=e.eq(0).attr("data-original-index"),o=$(".community-backtest-select-dialog").find("#backtest").find("option").eq(a),i=o.attr("value");o.attr("_uniqueCode"),$("#source-backtest").attr("_uniqueCode");i&&Cy.ajax("/algorithm/live/changeBacktest",{data:"backtestId="+backtestId+"&sourceBacktestId="+i,async:!1,success:function(t){return selectedBacktestName=t.data.name,sourceBacktestId=t.data.backtestId,$("#source-backtest").html(selectedBacktestName),$("#source-backtest").attr("_uniqueCode",t.data.uniqueCode),$("#source-backtest").attr("href","/algorithm/backtest/detail?backtestId="+i),$("#code-view").html(""),$("#code-view").attr("_isLoad","0"),$("#code-item").attr("_hasDrawn","0"),editor&&(editor.destroy(),editor=null,drawCode("#code-view")),getUpdateCodeHistoryList(1),BootstrapDialog.show({title:"提示",message:"替换代码成功!"}),!1},fail:function(t){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"修改失败:"+t.msg})}})}t.close()}}],onshown:function(t){var e=$(".bootstrap-dialog-message").eq(0);if($("#local_algorithmId").val()<=0)e.html('<p class="mt_20" style="margin-bottom:0">该策略通过金融终端建立，请在提交模拟交易的终端上进行修改。</p>');else{e.html($("#backtest-select-dom").html()),$(".community-backtest-select-dialog").find("select").selectpicker();var a=$("#source-backtest").attr("_uniqueCode");updateBacktestList("/algorithm/backtest/doneList?algorithmId="+algorithmId+"&pyVersion="+pyVersion,a)}}})},onEditTradeName=function(t){var e=$("#backtest_setting_name").html();return BootstrapDialog.show({title:"修改模拟交易名称",message:'<br/><span style="float:left;padding-top:6px">名称：</span> <input id="name" type="text" class="form-control" value="'+e+'" style="width:80%;margin-bottom:10px"></div>',buttons:[{label:"提交",action:function(e){var t=e.getModalBody().find("#name"),a=t.val(),o=$("#backtest_setting_name").html(),i=a||o;return(a=a.replace(/\s/g,""))&&!/^\S{1,100}$/.test(a)?(BootstrapDialog.show({title:"提示",message:"名称过长，请重新输入。",onhidden:function(){t.val(o)}}),!1):a?void Cy.ajax("/algorithm/backtest/setName",{data:"backtestId="+backtestId+"&name="+i,success:function(t){return $("#backtest_setting_name").html(i),$("#backtest_name").html(i),$("#title-box").val(i),e.close(),!1},fail:function(t){e.close(),BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:t.msg})}}):(BootstrapDialog.show({title:"提示",message:"名称不能为空",onhidden:function(){t.val(o)}}),!1)}},{label:"取消",action:function(t){t.close()}}]}),t.stopPropagation(),!1},onLogClear=function(t){BootstrapDialog.show({title:"警告",message:"确定一键清空日志？清空后不可恢复！",buttons:[{label:"确定",action:function(t){Cy.ajax("/algorithm/live/clearLog?backtestId="+backtestId,{success:function(t){$(".opacity-tool").css({display:"block"}),setTimeout(function(){$(".opacity-tool").css({display:"none"})},1500)}}),t.close()}},{label:"取消",action:function(t){t.close()}}]})},onUpdateTradeName=function(t){var e=$(this),a=e.html(),o=$("#title-box");e.addClass("hidden"),o.val(a).removeClass("hidden").focus().select(),$(".beta-label").addClass("hidden")},onSubmitUpdateTradeName=function(t){var e=$(this);$(this).val($(this).val().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"));var a=e.val(),o=$("#backtest_name"),i=$("#backtest_name").html(),n=a||i;return(a=a.replace(/\s/g,""))?/^\S{1,100}$/.test(a)?(toSubmitNewName(a),e.addClass("hidden"),$(".beta-label").removeClass("hidden"),$("#backtest_setting_name").html(n),void o.html(n).removeClass("hidden")):(BootstrapDialog.show({title:"提示",message:"名称过长，请重新输入。",onhidden:function(){e.val(i).focus().select()}}),!1):(BootstrapDialog.show({title:"提示",message:"名称不能为空",onhidden:function(){e.val(i).focus()}}),!1)},onCheckTradeName=function(){var t=$(this),e=t.val();if(!/^[a-zA-Z0-9\u4e00-\u9fa5\()@_\-\.:\/\s']+$/.test(e))return e=e.replace(/[^a-zA-Z0-9\u4e00-\u9fa5\()@_\-\.:\/\s']/g,""),t.val(e),!1},onBacktestShareCancel=function(t){BootstrapDialog.confirm("取消分享可能影响您的个人排名，确定要取消分享吗？",function(t){if(!t)return!1;Cy.ajax("/algorithm/live/cancelShare",{data:"backtestId="+backtestId,async:!1,success:function(t){window.location.href=window.location.href},fail:function(t){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:t.msg})}})})},onSubmitShareInfo=function(t){var e=$("#introduce").html(),a=$("#introduce").attr("shareTitle");return BootstrapDialog.show({title:"修改策略分享信息",message:'名称： <input id="title" type="text" class="form-control" value="'+a+'" style="width:98%;margin-bottom:10px"><br/>策略思路： <textarea id="introduce" class="form-control" value="" style="height:300px;width:98%;">'+e+"</textarea>",buttons:[{label:"提交",cssClass:"btn-primary",action:function(e){var a=e.getModalBody().find("#introduce").val(),o=e.getModalBody().find("#title").val();Cy.ajax("/algorithm/live/setIntroduce",{data:"backtestId="+backtestId+"&introduce="+a+"&title="+o,async:!1,success:function(t){return $("#introduce").html(a),$("#introduce").attr("shareTitle",o),e.close(),!1},fail:function(t){e.close(),BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:t.msg})}})}},{label:"取消",action:function(t){t.close()}}]}),t.stopPropagation(),!1},onChartPerformance=function(t){var e=$(this).attr("_href");$(".chart_item").removeClass("active"),$(this).addClass("active"),$(".charts").removeClass("active"),$(e).addClass("active"),"#today_earnings"==e?($(".exceedReturn").hide(),$(".dayExceedReturn").show(),$("#portfolio-perf-label").addClass("today_po")):($(".dayExceedReturn").hide(),$(".exceedReturn").show(),$("#portfolio-perf-label").removeClass("today_po"))},onShowModalChartDialog=function(t){"modal_chart"!=t.target.id&&"closed"!=t.target.className&&"close"!=t.target.className&&"modal-dialog"!=t.target.className||$(this).removeClass("in").css({display:"none"})},onShowHelp=function(t){$(this).parent().addClass("hidden"),setCookie("tips","1",5256e3)},onUpdateBacktest=function(t){$("#title-box").val();BootstrapDialog.show({title:"申请更新",cssClass:"updata-dialog",message:"",buttons:[{label:"确定",action:function(t){var e=$(".updata-dialog").find("#backtestgx").parent().find('li[class="selected"]');if(0<e.length){var a=e.eq(0).attr("data-original-index"),o=$(".updata-dialog").find("#backtestgx").find("option").eq(a),i=o.attr("value"),n=(o.attr("_uniqueCode"),$("#source-backtest").attr("_uniqueCode"),$(".updata-dialog").find("#introduce").val());i&&Cy.ajax("/algorithm/live/changeBacktest",{data:"backtestId="+backtestId+"&sourceBacktestId="+i+"&introduce="+n,async:!1,success:function(t){return selectedBacktestName=t.data.name,sourceBacktestId=t.data.backtestId,$("#source-backtest").html(selectedBacktestName),$("#source-backtest").attr("_uniqueCode",t.data.uniqueCode),$("#source-backtest").attr("href","/algorithm/backtest/detail?backtestId="+i),$("#code-view").html(""),$("#code-view").attr("_isLoad","0"),$("#code-item").attr("_hasDrawn","0"),editor&&(editor.destroy(),editor=null,drawCode("#code-view")),getUpdateCodeHistoryList(1),BootstrapDialog.show({title:"提示",message:"替换代码成功!"}),!1},fail:function(t){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"更新失败:"+t.msg})}})}t.close()}}],onshown:function(t){$(".bootstrap-dialog-message").eq(0).html($("#backtest-select-gxdom").html()),$(".updata-dialog").find("select").selectpicker();var e=$("#source-backtest").attr("_uniqueCode");updateBacktestList1("/algorithm/backtest/doneList?algorithmId="+algorithmId+"&pyVersion="+pyVersion,e)}})},onEditTradeInfo=function(t){var r=$(this).attr("backtestId"),l=$(this).attr("data-type"),e=($(this).attr("tradename"),$(this).attr("endtime")),d=$(this).attr("frequency"),c="";c="2030-12-31 00:00:00"==e?" 永久":e.substring(0,10)+"到期","day"===d?d=0:"minute"===d?d=1:d=2,Cy.ajax("/algorithm/trade/NewNullTrade",{data:{backtestId:r},async:!1,success:function(t){if("00000"==t.code){var e="",a=!1;if(t.data.length)for(var o=0;o<t.data.length;o++)t.data[o].expireTime&&(t.data[o].role?parseInt(t.data[o].role)>=d&&0<t.data[o].count&&("2030-12-31 00:00:00"==t.data[o].expireTime?e+='<option data-backtestSpaceId="'+t.data[o].backtestSpaceId+'" value="'+t.data[o].expireTime+'">永久</option>':e+='<option data-backtestSpaceId="'+t.data[o].backtestSpaceId+'" value="'+t.data[o].expireTime+'">'+t.data[o].expireTime.substring(0,10)+"到期</option>"):"2030-12-31 00:00:00"==t.data[o].expireTime?e+='<option value="'+t.data[o].expireTime+'">永久</option>':e+='<option value="'+t.data[o].expireTime+'">限时('+t.data[o].expireTime.substring(0,10)+"到期)</option>");else e="<option>无</option>",a=!0;if("frequency"===l)var i="修改模拟交易位",n='<span style="display:block;">当前模拟交易位：<span style="margin-left:10px">'+c+'</span></span><br/><span>可选模拟交易位：</span><select name="" id="expireTime" style="padding:5px 10px;border:1px solid #d1d3da;min-width:200px">'+e+"<select>";else i="修改时限",n='<span>当前时限：<span style="margin-left:10px">'+c+'</span></span><br/><span>可选时限：</span><select name="" id="expireTime" style="padding:5px 10px;border:1px solid #d1d3da;min-width:200px">'+e+"<select>";var s={label:"确定",cssClass:"btn-primary",action:function(e){var t=e.getModalBody().find("#expireTime").val(),a=e.getModalBody().find("#expireTime option:checked").attr("data-backtestSpaceId");Cy.ajax("/algorithm/trade/replaceBacktestSpace",{data:"backtestId="+r+"&expireTime="+t+"&backtestSpaceId="+a,success:function(t){if("00000"==t.code)return e.close(),BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"编辑成功！"}),location.reload(),!1},fail:function(t){e.close(),BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:t.msg})}})}};a&&(s={label:"积分兑换",cssClass:"btn-primary",action:function(t){window.location.href="/view/credits/detail/8?direct=/algorithm/live/index?backtestId="+r}}),BootstrapDialog.show({title:i,message:n,buttons:[{label:"取消",action:function(t){t.close()}},s]})}},fail:function(t){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"无法编辑:"+t.msg})}})},onMessageSwitch=function(t,e){e?(cancelSwitchFlag=!0,shareLinkFun()):(switchFlag=!0,cancelShareLinkFun())},onAreadyApplyShareUrl=function(){$('[href="#pane_settings"]').click()},handleClickModifyAlgorithmCode=function(){"1"===$("#code-view").attr("_isLoad")&&($(".live__algorithm-code-edter-btns_operation").addClass("hidden"),$(".live__algorithm-code-edter-btns_editing").removeClass("hidden"),editor.setReadOnly(!1))},handleClickCancelModifyAlgorithmCode=function(){$(".live__algorithm-code-edter-btns_editing").addClass("hidden"),$(".live__algorithm-code-edter-btns_operation").removeClass("hidden"),editor.setValue(algorithmCode,-1),editor.setReadOnly(!0)},handleClickCompleteModifyAlgorithmCode=function(){$(".live__algorithm-code-edter-btns_editing").addClass("hidden"),$(".live__algorithm-code-edter-btns_operation").removeClass("hidden"),editor.moveCursorTo(-1,-1),editor.setReadOnly(!0);var e=editor.getValue();Cy.ajax("/algorithm/live/changeCode",{data:{backtestId:backtestId,code:e},success:function(t){"00000"==t.code&&(BootstrapDialog.show({title:"提示",message:"修改代码成功!"}),algorithmCode=e,getUpdateCodeHistoryList(1))},fail:function(t){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"修改代码失败:"+t.msg})}})},onListenerKeyDown=function(t){$("body").hasClass("modal-open")||($("#pane_results").hasClass("active")?chartKeydown(t):$("#pane_stats").hasClass("active")&&chartStatKeydown(t))},getLiveShopStatus=function(){$("#shareInfo").get(0)&&Cy.ajax("/algorithm/live/GetLiveShopStatus",{type:"GET",data:{backtestId:backtestId},success:function(t){"0"===t.data.status?$("#shareInfo").html("审核中").addClass("btn-alshareInfo"):"1"===t.data.status?$("#shareInfo").html("已上架").addClass("btn-alshareInfo"):"2"===t.data.status?$("#shareInfo").html("已下架").addClass("btn-alshareInfo"):"3"===t.data.status&&$("#shareInfo").html("审核通过").addClass("btn-alshareInfo"),$("#shareInfo").removeClass("hidden")},fail:function(t){console.log(t)}})},handleChangeHistoryIdRemark=function(){var t=$(this),e=t.data("historyid"),a=t.data("remark");BootstrapDialog.confirm({title:"修改备注",message:'<p style="margin-top: 10px"><span>备注：</span><input class="form-control" style="display: inline-block; width: 300px;" autocomplete="off" type="text" id="newHistoryRemark" value="'+a+'"/></p>',callback:function(t){t&&Cy.ajax("/algorithm/live/setHistoryRemark",{data:{liveHistoryId:e,introduce:$("#newHistoryRemark").val()},dataType:"JSON",success:function(t){"00000"===t.code&&(BootstrapDialog.alert("修改成功"),getUpdateCodeHistoryList())}})}})},handleLogsSwitch=function(){var t=$(this).data("target");$(".logs-switch").find(".active").removeClass("active"),$(".logs-switch").find('span[data-target="'+t+'"]').addClass("active"),$(".logs-container").hide(),$("#"+t).show()},bindListener=function(){$node.delegate("#exceedReturn, #dayExceedReturn","click",onToggleExcessData),$node.delegate("#pane-jiaoyi","click",onPaneTrade),$node.delegate("#pane-chic","click",onPaneChic),$node.delegate(".pane-item","click",onPaneItem),$node.delegate("#pauseBtn","click",onPauseTrade),$node.delegate("#restartBtn","click",onRestartTrade),$node.delegate("#resumeBtn","click",onResumeTrade),$node.delegate("#finishBtn","click",onFinishTrade),$node.delegate("#name-edit-btn","click",onEditTradeName),$node.delegate(".change-history-id-remark","click",handleChangeHistoryIdRemark),$node.delegate("#btn-clear","click",onLogClear),$node.delegate("#backtest_name","click",onUpdateTradeName),$node.delegate("#title-box","blur",onSubmitUpdateTradeName),$node.delegate("#title-box, #name","keyup",onCheckTradeName),$node.delegate("#cancel-share-backtest-button","click",onBacktestShareCancel),$node.delegate("#introduce-edit-btn","click",onSubmitShareInfo),$node.delegate("#modal_chart","click",onShowModalChartDialog),$node.delegate(".tips_btn","click",onShowHelp),$node.delegate("#btn-select-gx","click",onUpdateBacktest),$node.delegate(".edit","click",onEditTradeInfo),$node.delegate("#applyShareUrl","click",shareLinkFun),$node.delegate(".msg-switch","switchChange.bootstrapSwitch",onMessageSwitch),$node.delegate("#aready-applyShareUrl","click",onAreadyApplyShareUrl),$node.delegate(".live__algorithm-code-edter-modify-btn","click",handleClickModifyAlgorithmCode),$node.delegate(".live__algorithm-code-edter-replace-btn","click",onBacktestSelect),$node.delegate(".live__algorithm-code-modify-cancel-btn","click",handleClickCancelModifyAlgorithmCode),$node.delegate(".live__algorithm-code-modify-complete-btn","click",handleClickCompleteModifyAlgorithmCode),$node.find("#position-column-select").delegate("input","click",onSelectPositionColumn),$node.find("#transaction-column-select").delegate("input","click",onTransactionColumnSelect),$node.find("#performance-chart").delegate(".chart_item","click",onChartPerformance),$node.on("keydown",onListenerKeyDown),$node.delegate(".community-backtest-select-dialog #backtest","change",pythonVersionChange),$node.delegate(".history-code","click",onShowHistoryCodeDialog),$node.delegate(".logs-switch span","click",handleLogsSwitch)},initPlugins=function(){isDelayTrade||initdayResult(lastDay,"daychart"),initResult(backtestId,function(){initDone=!0,$("#result-loading").addClass("hidden"),isDelayTrade&&$(".today-chart-delay-remark").removeClass("hidden"),fillStats(),$("body").hasClass("mobile")?(getPosition(today),getTransaction(today),getjiaoyi(today),getchic(today)):(getPosition(lastDate,1),getTransaction(lastDate)),getTradeTimeText(status),WH(),tips()}),isOwner&&initPage(),getLiveShopStatus(),handleToggleDrapdown()},init=function(){parseDOM(),bindListener(),initPlugins()};init()});